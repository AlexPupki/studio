# Журнал изменений

Все заметные изменения в этом проекте будут задокументированы в этом файле.

## [Stage 2] - YYYY-MM-DD

### Added
- **Надежность API**: Внедрен механизм идемпотентности для всех мутирующих эндпоинтов бронирования (`hold`, `confirm`, `invoice`).
- **Безопасность**: Добавлено ограничение частоты запросов (rate limiting) на базе Redis для защиты от злоупотреблений.
- **Целостность данных**: Усилена схема БД PostgreSQL с помощью `CHECK` и `UNIQUE` constraints, а также GIST-индексов для предотвращения овербукинга.
- **Автоматизация**: Создана фоновая cron-задача для автоматической отмены просроченных бронирований (`hold`).
- **Аутентификация Cron**: Задача защищена HMAC-подписью для безопасного вызова.
- **Транзакционность**: Все операции с базой данных, изменяющие несколько сущностей, обернуты в транзакции с логикой повторных попыток при ошибках сериализации.
- **Конфигурация**: Все секреты (CRON_SECRET, JWT_SECRET, SESSION_SECRET_KEY, PEPPER) вынесены в Google Secret Manager.
- **Тестирование**: Добавлена инфраструктура для unit-тестирования (Vitest) и E2E-тестирования (Playwright).
- **Документация**: Обновлена вся релевантная документация (`stage_2_playbook`, `openapi.yaml`, `README.md`) и введено версионирование.
- **Операторская панель**: Добавлены базовые страницы для просмотра бронирований и логов. Доступ защищен через Firebase Auth Custom Claims.
- **Контент-модули**: Добавлены схемы и документация для управления страницами и постами блога с поддержкой SEO.
- **Личный кабинет**: Реализован базовый личный кабинет для пользователей с историей бронирований.

### Changed
- **API**: Заголовок `Idempotency-Key` стал обязательным для всех мутирующих эндпоинтов.
- **Архитектура**: Все критически важные функции для работы с БД (`holdCapacity`, `confirmCapacity` и т.д.) теперь требуют явной передачи объекта транзакции.
- **Аутентификация операторов**: Переведена на JWT с проверкой ролей в middleware.

---

## [Stage 1] - YYYY-MM-DD

### Added
- **Фундамент проекта**: Инициализирован проект на стеке Next.js, TypeScript, Drizzle, ShadCN, Tailwind.
- **Аутентификация**: Реализована беспарольная аутентификация по номеру телефона (OTP через SMS-заглушку).
- **Сессии**: Внедрены безопасные cookie-сессии (`HttpOnly`, `Secure`, `SameSite=Lax`).
- **Архитектурные решения (ADR)**: Зафиксированы ключевые решения по выбору БД, файлового хранилища, CRM и стратегии аутентификации.
- **Базовая структура**: Создана базовая структура папок, разделение на клиентский и серверный код.
- **UI-компоненты**: Настроены базовые компоненты ShadCN.
- **Операторская панель**: Созданы заглушки страниц для `/ops` под базовой защитой.
- **API-документация**: Инициализирован `openapi.yaml` для спецификации API.
