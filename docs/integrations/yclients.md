# Интеграция с YCLIENTS

**Версия: 1.0.0**

Этот документ описывает архитектуру и принципы работы адаптера для интеграции с CRM-системой YCLIENTS.

## 1. Назначение

Адаптер предоставляет стандартизированный интерфейс (`IYclientsAdapter`) для взаимодействия с YCLIENTS API. Он инкапсулирует логику HTTP-запросов, аутентификации, обработки ошибок и повторных попыток.

Основная цель — изолировать остальную часть приложения от деталей реализации API конкретного провайдера.

## 2. Конфигурация

Интеграция управляется через переменные окружения и фича-флаг.

### Переменные окружения

- **`UCLIENTS_API_URL`**: Базовый URL для API YCLIENTS (например, `https://api.yclients.com/api/v1`).
- **`UCLIENTS_API_KEY`**: `user_token`, полученный из YCLIENTS для аутентификации.
- **`UCLIENTS_WEBHOOK_SECRET`**: Секретный ключ для верификации входящих вебхуков (пока не используется).
- **`UCLIENTS_TZ`**: Часовой пояс, в котором работает компания в YCLIENTS (например, `Europe/Moscow`).

### Feature Flag

- **`FEATURE_UCLIENTS_ENABLED`**:
  - `true`: Используется реальный адаптер `YclientsAdapter`, который отправляет запросы в YCLIENTS.
  - `false` (по умолчанию): Используется `StubYclientsAdapter`, который логирует вызовы в консоль и возвращает заглушки. Это позволяет вести разработку и тестирование без реального доступа к API.

## 3. Архитектура

Модуль состоит из нескольких слоев:

1.  **`service.ts` (Фабрика)**:
    - Экспортирует единственную функцию `createYclientsService()`.
    - Эта функция решает, какой адаптер (реальный или заглушку) создать, основываясь на фича-флаге `FEATURE_UCLIENTS_ENABLED`.
    - Является единой точкой входа для остального приложения.

2.  **`adapter.ts` (Адаптеры)**:
    - **`YclientsAdapter`**: Реальная имплементация интерфейса `IYclientsAdapter`. Использует `api-client.ts` для выполнения запросов.
    - **`StubYclientsAdapter`**: Имплементация-заглушка. Никуда не ходит, только пишет в консоль.

3.  **`api-client.ts` (HTTP-клиент)**:
    - Низкоуровневый клиент для отправки `fetch` запросов.
    - Автоматически подставляет `Authorization: Bearer ...` заголовок.
    - Реализует логику повторных попыток (retry) с экспоненциальной задержкой при сетевых сбоях или 5xx ошибках от сервера.
    - Пробрасывает `traceId` для сквозного логирования.

4.  **`contracts.ts` (Контракты)**:
    - Содержит TypeScript-интерфейс `IYclientsAdapter`, который определяет методы сервиса.

## 4. Использование

В любом серверном экшене или API-роуте, где требуется работа с YCLIENTS, необходимо использовать фабрику:

```typescript
// some.actions.ts
'use server';

import { createYclientsService } from '@/lib/server/integrations/yclients/service';

const yclients = createYclientsService();

export async function someAction() {
  const availability = await yclients.getAvailability(123, 456, '2024-09-10');
  // ...
}
```

Такой подход гарантирует, что мы работаем либо с реальным API, либо с предсказуемой заглушкой, в зависимости от конфигурации.
