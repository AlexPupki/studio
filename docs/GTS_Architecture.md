# Архитектура Платформы "Grand Tour Sochi"
**Версия: 1.3.0**

Этот документ — главный источник правды об архитектуре проекта. Он объединяет ключевые решения, правила и гайдлайны.

## 1. Философия и Принципы

- **Модульный Монолит**: Мы строим единое приложение, но с четким разделением на доменные модули (Каталог, Бронирования, Пользователи, Контент) для простоты разработки и поддержки.
- **Контракты в первую очередь (Contract-First)**: Взаимодействие между слоями (UI, BFF, сервисы) строго типипизировано через общие TypeScript-интерфейсы и спецификации OpenAPI.
- **Гексагональная Архитектура (Порты и Адаптеры)**: Бизнес-логика изолирована от внешних сервисов (БД, API, файловое хранилище). Интеграции реализуются через "адаптеры".
- **Фабрики Сервисов**: Экземпляры сервисов (AI, DB, Storage) создаются централизованно через асинхронные фабрики (`create...Service`), которые инкапсулируют всю логику конфигурации.

## 2. Стек Технологий

- **Frontend и BFF**: Next.js (App Router)
- **Язык**: TypeScript
- **UI**: React, ShadCN, Tailwind CSS
- **AI**: Genkit (Google AI)
- **Хостинг**: Firebase App Hosting / Google Cloud Run
- **Аутентификация**: **Firebase Auth** (для операторов), кастомные сессии (для клиентов).
- **База Данных**: **PostgreSQL** (основная), **Redis** (кэш, очереди, rate limits). (См. [ADR-001](./01_architecture/ADR-001-database-selection.md))
- **Хранилище Файлов**: **Google Cloud Storage (GCS)**. (См. [ADR-002](./01_architecture/ADR-002-storage-selection.md))
- **CI/CD**: GitHub Actions или Cloud Build

## 3. Управление Конфигурацией

Для обеспечения надежности и предсказуемости, мы используем централизованный подход к управлению переменными окружения.

- **Источник Правды**: Единственным источником правды для конфигурации является файл `src/lib/server/config.server.ts`.
- **Принцип работы**:
    1. При запуске приложения этот модуль один раз считывает все переменные из `process.env`.
    2. Он валидирует их с помощью строгой Zod-схемы, проверяя наличие обязательных полей и их типы. Это предотвращает запуск приложения с неверной конфигурацией.
    3. Все остальные части приложения **обязаны** получать доступ к конфигурации только через типобезопасные функции `getEnv()` и `getFeature()`, экспортируемые из этого модуля.
- **Запрет**: Прямой доступ к `process.env` в бизнес-логике или компонентах запрещен. Это позволяет избежать ошибок, связанных с опечатками в именах переменных или отсутствием значений.

## 4. Управление Файлами (Google Cloud Storage)

Мы используем GCS для хранения всех медиафайлов. Доступ осуществляется через временные подписанные URL (Signed URL v4), которые генерирует наш бэкенд.

- **Бакет**: `gts-mvp-media-euw4` (europe-west4)
- **Доступ**: Приватный по умолчанию. Публичный доступ запрещен на уровне бакета.

## 5. Интеграция с CRM

Приоритетной для MVP является интеграция с YCLIENTS. (См. [ADR-003](./01_architecture/ADR-003-crm-strategy.md))

### Вариант А (Приоритетный): YCLIENTS
- **Стиль API**: REST
- **Аутентификация**: Bearer-токен (`user_token`).

## 6. SEO и Контент

- **Генерация `sitemap.xml`**: Реализуется через специальный API-роут, который динамически строит карту сайта на основе опубликованных страниц и постов в блоге.
- **Генерация `robots.txt`**: Динамически генерируется для управления индексацией в разных окружениях (например, запрет индексации для `staging`).
- **Структурированные данные (JSON-LD)**: Для ключевых страниц (маршруты, посты) генерируется JSON-LD разметка (`Product`, `Article`, `BlogPosting`) для улучшения представления в поисковой выдаче.

## 7. Правила Кода и Изоляция Слоёв

- **Изоляция Серверного Кода**: Любой код, использующий Node.js-специфичные модули или тяжелые SDK, должен находиться в файлах с директивой `'use server'`.
- **Запрет Прямого Импорта**: Клиентские компоненты не могут импортировать серверные файлы напрямую. Взаимодействие — через Server Actions.
- **Разделение Зависимостей**: `dependencies` — для production, `devDependencies` — для сборки и тестов.

## 8. Документация

- **TSDoc/JSDoc**: Все экспортируемые функции, типы и классы должны иметь TSDoc-комментарии.
- **Markdown (`/docs`)**: Высокоуровневые архитектурные решения, гайды и ADR.
- **ADR (Architecture Decision Records)**: Важные архитектурные решения фиксируются в `/docs/01_architecture`.
- **Feature Flags**: Единый реестр фиче-флагов ведется в [ADR-004](./01_architecture/ADR-004-feature-flags-registry.md).

## 9. Транзакционность и надежность

- **Транзакции**: Все операции, изменяющие несколько сущностей (например, создание бронирования и обновление слота), должны быть обернуты в транзакции PostgreSQL.
- **Повторные попытки (Retries)**: Для борьбы с `serialization failure` при высоких нагрузках, транзакционная обертка `withPgTx` автоматически выполняет до 3 повторных попыток с экспоненциальной задержкой.
- **Идемпотентность**: Критически важные мутирующие эндпоинты (`hold`, `confirm`) защищены проверкой `Idempotency-Key` на базе Redis для предотвращения дублирующих операций.

## 10. Аутентификация и Доступ

- **Клиенты**: Беспарольная аутентификация по номеру телефона (OTP) с использованием безопасных `HttpOnly` cookie-сессий.
- **Операторы**: Аутентификация через **Firebase Auth**. Доступ к ресурсам `/ops` и `/api/ops` контролируется через **Custom Claims** (например, `roles: ['ops.viewer', 'ops.editor']`), которые проверяются в `middleware.ts`.
