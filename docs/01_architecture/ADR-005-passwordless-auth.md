# ADR 5: Выбор стратегии аутентификации для MVP

- **Дата**: 2024-08-24
- **Статус**: Accepted

## Контекст
Для первого этапа (Stage 1) платформы "Grand Tour Sochi" необходимо реализовать механизм аутентификации для роли "Клиент". Требуется выбрать подход, который будет быстрым в реализации, безопасным и удобным для конечного пользователя, чтобы не создавать барьеров при первом контакте с сервисом.

## Варианты Решений

### Вариант 1: Классическая аутентификация (Email/Пароль)
- **Описание**: Пользователь регистрируется, указывая email и придумывая пароль. Для входа он использует эту пару. Требуется реализация флоу "Забыли пароль?".
- **Плюсы**:
  - Самый распространенный и понятный для многих пользователей механизм.
- **Минусы**:
  - **Безопасность**: Требует хранения хэшей паролей, защиты от брутфорса, реализации политик сложности паролей. Увеличивает поверхность атаки.
  - **UX**: Пользователи вынуждены помнить еще один пароль. Процесс восстановления пароля может быть утомительным.
  - **Разработка**: Требует больше времени на реализацию (регистрация, логин, восстановление пароля, смена пароля).

### Вариант 2: Социальные логины (OAuth 2.0 через Google, VK и т.д.)
- **Описание**: Пользователь входит через свой аккаунт в социальной сети.
- **Плюсы**:
  - Удобно для пользователя, не нужно создавать новый аккаунт.
- **Минусы**:
  - **Зависимость**: Привязка к внешним провайдерам.
  - **Данные**: Не всегда удается получить номер телефона, который является ключевым идентификатором в нашей системе для связи с YCLIENTS.
  - **Сложность**: Требует настройки приложений у каждого провайдера и реализации OAuth-флоу.

### Вариант 3: Беспарольная аутентификация (Phone a.k.a. "Passwordless")
- **Описание**: Пользователь вводит номер телефона, получает на него одноразовый код (OTP) по SMS и входит в систему, вводя этот код. Телефон становится единственным идентификатором.
- **Плюсы**:
  - **Высокая безопасность**: Нет паролей, которые можно украсть или подобрать. Коды короткоживущие и одноразовые.
  - **Отличный UX**: Не нужно ничего помнить. Вход и регистрация — это один и тот же процесс.
  - **Ключевой идентификатор**: Мы сразу получаем номер телефона, который необходим для интеграции с YCLIENTS и операционной деятельности.
  - **Скорость разработки**: Флоу состоит всего из двух шагов (запрос кода -> верификация кода).
- **Минусы**:
  - Зависимость от SMS-шлюза и стоимость отправки SMS (на данном этапе решается использованием провайдера-заглушки).

## Решение
Мы выбрали **Вариант 3: Беспарольная аутентификация по номеру телефона**.
Обоснование: Этот подход наилучшим образом соответствует целям MVP, изложенным в `stage_1_playbook.md`. Он обеспечивает лучший баланс между скоростью разработки, безопасностью и удобством для пользователя. Получение номера телефона на первом шаге является критически важным для основного бизнес-процесса бронирования, что делает этот вариант стратегически верным.

## Последствия
- Вся система IAM на первом этапе будет построена вокруг номера телефона как основного идентификатора.
- В будущем система будет расширена:
  - **Stage 2**: Будет добавлена возможность выпускать JWT-токены для внешних API.
  - **Stage 3**: Будет введена полноценная ролевая модель (RBAC).
  - **Stage 4**: Будет рассмотрено добавление альтернативных факторов аутентификации (2FA), таких как Email или TOTP-приложения, для повышения безопасности аккаунтов партнеров и администраторов.
- Затраты на SMS будут учтены в операционных расходах после включения `FEATURE_REAL_SMS`.
