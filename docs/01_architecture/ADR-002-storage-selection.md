# ADR 2: Выбор файлового хранилища

- **Дата**: 2024-08-23
- **Статус**: Accepted

## Контекст
Платформе необходимо хранить медиафайлы (фотографии услуг, аватара) и генерируемые документы (PDF-инвойсы). Хранилище должно быть безопасным, масштабируемым и экономически эффективным. Доступ к файлам должен быть управляемым.

## Варианты Решений

### Вариант 1: S3-совместимое хранилище (например, MinIO на своих серверах или AWS S3)
- **Плюсы**:
  - S3 API является индустриальным стандартом, что обеспечивает гибкость.
  - Большое количество готовых библиотек.
- **Минусы**:
  - При самостоятельном хостинге (MinIO) требуются затраты на администрирование.
  - При использовании AWS S3 возникает зависимость от другого облачного провайдера, что может усложнить управление IAM и биллинг.

### Вариант 2: Google Cloud Storage (GCS)
- **Описание**: Используем нативное облачное хранилище от Google. Доступ к файлам организуется через временные подписанные URL (v4 signed URLs), генерируемые на бэкенде.
- **Плюсы**:
  - Нативная интеграция с остальным стеком Google Cloud и Firebase.
  - Единое управление доступом через IAM.
  - Высокая производительность и надёжность.
  - Безопасная модель доступа через signed URLs по умолчанию.
- **Минусы**:
  - Не является S3-совместимым "из коробки", хотя существуют способы такой настройки.

## Решение
Мы выбрали **Вариант 2: Google Cloud Storage (GCS)**.
Обоснование: Поскольку основной стек приложения разворачивается на Google Cloud (App Hosting, Cloud Run), использование GCS является наиболее логичным и естественным выбором. Это упрощает настройку, управление доступом и мониторинг. Использование v4 signed URLs для доступа к файлам является современным и безопасным подходом, который полностью соответствует требованиям проекта.

## Последствия
- Бэкенд-сервис должен включать логику для генерации v4 signed URLs для загрузки и скачивания файлов.
- В Google Cloud необходимо создать бакет с приватными настройками по умолчанию.
- Сервисному аккаунту приложения потребуются права для подписи URL (`iam.serviceAccountTokenCreator`).
