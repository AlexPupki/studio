# Stage 1: Фундамент — Production-Ready Аутентификация

**Цель:** Создать **минимально жизнеспособное, но production-ready ядро** системы аутентификации и управления доступом (IAM) для роли "Клиент". Этот этап — фундамент для всех будущих ролей и защищенных разделов.

## 0. Scope & Non-Goals (Ожидания)

-   **В Scope:**
    -   Вход по номеру телефона через одноразовый пароль (SMS-OTP).
    -   Серверные сессии, управляемые через `HttpOnly` cookie.
    -   Базовая локализация (i18n) для форм и ошибок (RU/EN).
    -   Защита от брутфорса (rate-limiting).
    -   Детальное логирование событий безопасности.
    -   Минимальный UI для флоу `login -> verify -> /account`.
-   **Не делаем в Stage 1:**
    -   Разграничение ролей и прав (RBAC). Все пользователи на этом этапе — "Клиенты".
    -   Двухфакторная аутентификация (2FA).
    -   Выпуск JWT для внешних API (кроме как за флагом `FEATURE_JWT_ISSUING`).
    -   Интеграция с реальными SMS-шлюзами (используем заглушку).
    -   Социальные логины (Google, Apple и т.д.).

---

## 1. Feature Flags и Переменные Окружения

Все флаги управляются через переменные окружения. Единый реестр ведется в [ADR-004](/docs/01_architecture/ADR-004-feature-flags-registry.md). Ключевые для этого этапа:

-   **`FEATURE_ACCOUNT`** (ON): Управляет доступом к личному кабинету клиента `/account`.
-   **`FEATURE_I18N`** (ON): Включает локализацию (RU/EN).
-   **`FEATURE_REAL_SMS`** (OFF): Переключает между провайдером-заглушкой и реальным SMS-шлюзом.
-   **`FEATURE_CAPTCHA`** (OFF): Включает CAPTCHA.
-   **`FEATURE_JWT_ISSUING`** (OFF): Включает генерацию JWT.

Полный список переменных окружения и их назначение задокументированы в файле `.env.example`.

---

## 2. Модель Данных IAM (MVP)

Контракты определены в `src/lib/iam/iam.contracts.ts`.

-   **`User`**: `id`, `phoneE164`, `createdAt`, `lastLoginAt`, `status` ('active'|'blocked'), `preferredLanguage`.
-   **`LoginCode`**: `id`, `phoneE164`, `codeHash`, `expiresAt`, `attempts`, `createdIp`, `createdUa`.
-   **`Session`**: `id`, `userId`, `issuedAt`, `expiresAt`, `ip`, `ua`, `revokedAt`.
-   **`AuditEvent`**: `id`, `ts`, `userId`, `event`, `ip`, `ua`, `meta_json`.

**Политики хранения и генерации OTP:**
-   **Генерация:** 6 цифр.
-   **Срок жизни (TTL):** 5 минут. Код одноразовый и инвалидируется после успешной верификации.
-   **Хранение:** В БД хранится **только хэш кода** (`codeHash`).
-   **Безопасность:** Используется "перец" (`PEPPER`) при хэшировании. Ответы сервера на неверный номер/код идентичны для защиты от атак перечисления.

---

## 3. Защита от Брутфорса и Злоупотреблений

-   **Нормализация телефона:** Все номера приводятся к формату E.164.
-   **Rate Limiting (схема ключей для Redis):**
    -   `rl:req_code:ip:{IP}`: Не более 3 запросов в минуту с одного IP.
    -   `rl:req_code:phone:{E164}`: Не более 5 запросов в час на один номер телефона.
    -   `rl:verify:phone:{E164}:{id}`: 5 неудачных попыток на один выданный код.
-   **Блокировка:** При превышении лимитов, номер/IP временно блокируются на 15 минут.
-   **CAPTCHA:** (Под флагом `FEATURE_CAPTCHA`) После 2 неудачных попыток ввода кода, пользователю показывается CAPTCHA.

---

## 4. Сессии и Безопасность

-   **Cookies:** Сессионные куки устанавливаются с флагами:
    -   `HttpOnly`: Защита от доступа через JavaScript.
    -   `Secure`: Передача только по HTTPS (в production).
    -   `SameSite=Lax`: Защита от CSRF-атак.
    -   `Path=/`: Кука доступна на всем сайте.
    -   **TTL:** 30 дней (настраивается через `SESSION_TTL_DAYS`).
-   **Шифрование/Подпись:** Сессия подписывается/шифруется с использованием секрета `SESSION_SECRET_KEY`.
-   **Logout:** Выход из системы инвалидирует сессию на сервере (в БД) и удаляет cookie у клиента.
-   **CSRF:** Мутирующие операции выполняются через Server Actions (POST) со встроенной CSRF-защитой Next.js.

---

## 5. Архитектура: Адаптеры и Изоляция

-   **`ISmsProvider`:** Интерфейс с реализациями `StubSmsProvider` (для разработки) и `RealSmsProvider` (для прода).
-   **`IRateLimiter`:** Интерфейс с реализациями in-memory (для dev) и Redis (для prod).
-   **Изоляция:** Весь серверный код (экшены, сервисы) находится в файлах с суффиксом `*.server.ts`.

---

## 6. UX и Детали Потока Входа

-   **UI:** Кнопка "Изменить номер" на экране ввода кода, маскирование номера (`+7 (***) ***-**-12`), таймер обратного отсчета (60с).
-   **Поля ввода:** `inputmode="numeric"`, `autocomplete="one-time-code"` для удобства на мобильных устройствах.
-   **Локализация:** Все тексты ошибок, подсказок и кнопок локализованы (RU/EN).
-   **Поддержка:** Ссылка "Нужна помощь?" для быстрой связи.

---

## 7. Логирование и Наблюдаемость

-   **Структурные логи:** Все ключевые события (`login_code_requested`, `login_code_verified`, `session_created`) логируются в JSON.
-   **Бизнес-метрики:** Отслеживание конверсии воронки `request → verify → session`.
-   **Приватность:** PII (номера телефонов) в логах хэшируются.

---

## 8. Документация и ADR

-   **ADR:** Создан документ, объясняющий решение использовать аутентификацию по телефону без пароля.
-   **Диаграммы:** Будет создана секвенс-диаграмма потока `Login → Verify → Session`.
-   **Ключи локализации:** Будет составлена таблица ключей для текстов (`auth.invalid_code`, `auth.code_expired`).

---

## 9. Тестирование

-   **Unit-тесты:** Для `PhoneNormalizer`, сервисов генерации и проверки кодов, управления сессиями.
-   **Интеграционные тесты:** Для серверных экшенов с моками внешних зависимостей.
-   **E2E-тесты (Playwright):** Сценарии "happy path", ввод неверного/просроченного кода, проверка кулдауна.

---

## 10. CI/CD и Гигиена Конфигурации

-   **`.env.example`:** Создан и поддерживается.
-   **Quality Gates:** CI настроен на автоматический запуск линтера, тайпчекера и тестов.
-   **Секреты:** Никаких ключей в коде. Все секреты только через переменные окружения.

---

## 11. Юридические аспекты и Приватность

-   **Согласие:** На форме входа должен быть обязательный чекбокс со ссылкой на Политику конфиденциальности.
-   **Хранение данных:** Политика хранения персональных данных и логов будет определена и задокументирована.

---

## 12. Совместимость с Будущим

-   **JWT:** Предусмотрена возможность выпуска JWT (под флагом `FEATURE_JWT_ISSUING`).
-   **Аудит:** В `AuditEvent` заложено поле `actor` для поддержки анонимных действий.

---

## 13. Контракты и Архитектура кода

Контракты для домена IAM определены в `src/lib/iam/iam.contracts.ts`. Структура кода следует гексагональной архитектуре.

---

## 14. Definition of Done (Критерии готовности)

-   [ ] Формы `login` и `verify` работают, используя заглушку SMS-провайдера и rate-limiter.
-   [ ] Cookie-сессия создается с флагами `HttpOnly`, `Secure`, `SameSite=Lax`.
-   [ ] Функция `logout` корректно инвалидирует сессию на сервере и удаляет cookie.
-   [ ] Страница `/account` доступна только авторизованным пользователям и находится под флагом `FEATURE_ACCOUNT`.
-   [ ] Реализованы корректные редиректы: `/account` → `/login` без сессии и обратно после входа.
-   [ ] Весь серверный код находится в `*.server.ts`.
-   [ ] Ключевые события логируются; сообщения об ошибках локализованы (RU/EN).
-   [ ] Unit и интеграционные тесты покрывают основную логику и проходят в CI.
-   [ ] Созданы ADR и секвенс-диаграмма.
-   [ ] Включены базовые метрики и есть дашборд конверсии.
-   [ ] Есть операционный runbook для основных инцидентов.

---

## 15. План Миграции на Stage 2

-   **Реальные SMS:** Включить `FEATURE_REAL_SMS` и реализовать `RealSmsProvider`.
-   **JWT для API:** Включить `FEATURE_JWT_ISSUING` для поддержки Ops API.
-   **RBAC:** Ввести модели `Role`, `Permission` и связать их с моделью `User`.
