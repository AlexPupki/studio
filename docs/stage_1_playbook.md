# Stage 1: Фундамент — MVP Аутентификация

**Цель:** Создать ядро системы доступа для роли "Клиент". На этом этапе мы строим **минимально жизнеспособный (MVP) вариант** домена Identity & Access Management (IAM), который позволит нам реализовать защищенные разделы.

**Важное замечание:** Эта реализация является **заглушкой (stub)** для полноценного IAM, описанного в `GTS Backend & Platform Blueprint`. Полноценная система с ролями, 2FA, аудитом и JWT для API будет реализована на следующих этапах.

---

## Задачи (Декомпозиция)

### Шаг 1: Проектирование и реализация MVP-аутентификации

- **Задача:** Разработать безопасный механизм входа по номеру телефона.
- **Логика:**
  - Пользователь вводит номер телефона.
  - Система (пока в виде заглушки) "отправляет" SMS с кодом подтверждения. На самом деле, мы будем просто выводить код в консоль сервера для отладки.
  - Пользователь вводит полученный код.
  - Сервер проверяет код и, в случае успеха, создает **зашифрованную cookie-сессию**, идентифицирующую пользователя.
- **Архитектурные требования:**
  - Все серверные экшены должны находиться в файлах с суффиксом `*.server.ts` (например, `src/lib/actions/auth.actions.server.ts`), чтобы обеспечить строгую изоляцию серверного кода.
  - **Сессионные Cookies** должны быть установлены с флагами `HttpOnly`, `Secure` (для production), `SameSite=Strict` и иметь ограниченное время жизни (TTL).
  - На данном этапе все аутентифицированные пользователи по умолчанию получают роль `client`.
- **Требования по безопасности (Placeholders):**
  - Необходимо предусмотреть механизм **rate-limiting** для запросов кода (по IP и номеру телефона).
  - Код подтверждения должен иметь короткое **время жизни (TTL)**, например, 5 минут.
- **Компоненты и Экшены:**
  - [ ] Создать страницу входа `src/app/login/page.tsx` с формой для ввода номера телефона.
  - [ ] Создать серверный экшен `requestLoginCodeAction(phone)` в `src/lib/actions/auth.actions.server.ts`.
  - [ ] Создать страницу верификации `src/app/login/verify/page.tsx` с формой для ввода кода.
  - [ ] Создать серверный экшен `verifyLoginCodeAction(phone, code)` в `src/lib/actions/auth.actions.server.ts`.

### Шаг 2: Создание базового Личного Кабинета (под флагом)

- **Задача:** Создать защищенную страницу `/account`, доступную только для аутентифицированных пользователей.
- **Статус:** Данный функционал в v1 не является обязательным (согласно blueprint) и должен разрабатываться с учетом **feature-флага `FEATURE_ACCOUNT`**.
- **Логика:**
  - Страница `/account` должна проверять наличие валидной сессии.
  - Если пользователь не вошел, его должно перенаправлять на страницу `/login`.
  - Если вошел — показывать базовую информацию о его аккаунте.
- **Компоненты и Экшены:**
  - [ ] Создать страницу `src/app/account/page.tsx`.
  - [ ] Реализовать в ней вызов экшена `getAccountDetailsAction` (который уже спроектирован).
  - [ ] Отобразить на странице имя пользователя, его статус в клубе и историю записей.
  - [ ] Добавить на страницу кнопку "Выйти", которая будет вызывать экшен для удаления сессии.

### Шаг 3: Интеграция аутентификации в основной макет

- **Задача:** Обновить `MainLayout`, чтобы он динамически отображал состояние "Войти" или "Выйти".
- **Логика:**
  - `MainLayout` должен знать, аутентифицирован ли текущий пользователь (через проверку сессии).
  - Вместо статичной кнопки "Войти", он должен показывать либо ее, либо имя пользователя и кнопку "Выйти".

## Что не входит в Stage 1:

- Разделение на роли (сотрудник, партнер). Пока все вошедшие пользователи — `client`.
- Полноценный IAM с 2FA, аудитом, сменой пароля.
- Использование JWT. Текущая реализация на cookies предназначена для web-сессий. Будущий Ops API потребует JWT, и механизм должен быть совместим.
- Отправка реальных SMS.
- Админ-панель для управления пользователями или контентом.

После завершения этого этапа у нас будет работающее ядро системы с возможностью безопасного входа и защищенной зоной, полностью соответствующее нашим архитектурным принципам.