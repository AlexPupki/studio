# Stage 1: Фундамент — MVP Аутентификация и IAM

**Цель:** Создать ядро системы доступа для роли "Клиент". На этом этапе мы строим **минимально жизнеспособный (MVP) вариант** домена Identity & Access Management (IAM), который позволит нам реализовать защищенные разделы и заложить фундамент для всех будущих ролей.

**Важное замечание:** Эта реализация является **заглушкой (stub)** для полноценного IAM, описанного в `GTS Backend & Platform Blueprint`. Полноценная система с ролями, 2FA, аудитом и JWT для API будет реализована на следующих этапах.

---

## 1. Feature Flags и Конфигурация

- **`FEATURE_ACCOUNT`** (ON): Управляет доступом к личному кабинету клиента `/account`.
- **`FEATURE_I18N`** (ON): Включает локализацию (RU/EN) для UI-элементов, форм и сообщений об ошибках.
- **`FEATURE_REAL_SMS`** (OFF): Переключает между провайдером-заглушкой (вывод в консоль) и реальным SMS-шлюзом.
- **`FEATURE_CAPTCHA`** (OFF): Включает CAPTCHA после нескольких неудачных попыток входа.
- **`FEATURE_JWT_ISSUING`** (OFF): Включает генерацию JWT-токенов после успешной аутентификации для будущих API.
- **Документация:** Все флаги управляются через переменные окружения (см. `.env.example`).

---

## 2. Модель Данных IAM (MVP)

Для реализации базовой аутентификации будут использоваться следующие модели (в виде контрактов в `src/lib/iam/iam.contracts.ts`, реализация в БД будет позже):

- **`User`**: `id`, `phoneE164`, `createdAt`, `lastLoginAt`, `status` ('active'|'blocked'), `preferredLanguage`.
- **`LoginCode`**: `id`, `phoneE164`, `codeHash`, `expiresAt`, `attempts`, `createdIp`, `createdUa`.
- **`Session`**: `id`, `userId`, `issuedAt`, `expiresAt`, `ip`, `ua`, `revokedAt`.
- **`AuditEvent`**: `ts`, `userId`, `event` (например, `login_code_requested`), `ip`, `ua`, `meta_json`.

**Политики:**
- **TTL кода:** 5 минут.
- **Очистка (GC):** Просроченные `LoginCode` и `Session` записи должны удаляться фоновым процессом (например, cron-задача).

---

## 3. Защита от Брутфорса и Злоупотреблений

- **Нормализация телефона:** Все номера телефонов приводятся к формату E.164 перед использованием.
- **Rate Limiting:**
  - **Запрос кода (`requestLoginCode`):** Не более 3 запросов в минуту с одного IP. Не более 5 запросов в час на один номер телефона.
  - **Проверка кода (`verifyLoginCode`):** 5 неудачных попыток для одного выданного кода, после чего код становится недействительным.
- **Кулдаун:** Кнопка "Отправить код повторно" неактивна 60 секунд.
- **Блокировка:** При достижении лимитов, номер телефона/IP временно блокируются на 15 минут.
- **CAPTCHA:** (Под флагом `FEATURE_CAPTCHA`) После 2 неудачных попыток ввода кода, пользователю показывается CAPTCHA.

---

## 4. Сессии и Безопасность

- **Cookies:** Сессионные куки должны быть установлены с флагами:
  - `HttpOnly`: Защита от доступа через JavaScript.
  - `Secure`: Передача только по HTTPS (в production).
  - `SameSite=Lax`: Защита от CSRF-атак.
  - `Path=/`: Кука доступна на всем сайте.
  - **TTL:** 30 дней (настраивается через переменные окружения).
- **Шифрование:** Сессия подписывается/шифруется с использованием секрета `SESSION_SECRET_KEY` из переменных окружения.
- **Logout:** Выход из системы должен инвалидировать сессию на сервере (в БД) и удалять cookie у клиента.
- **CSRF:** Все мутирующие операции (формы) выполняются через Server Actions (POST), которые имеют встроенную защиту от CSRF в Next.js.

---

## 5. Архитектура: Адаптеры и Изоляция

- **`SmsProvider`:** Создается интерфейс `ISmsProvider` и две реализации: `StubSmsProvider` (для разработки, выводит код в консоль) и `RealSmsProvider` (будет интегрирована позже).
- **`RateLimiter`:** Абстрактный сервис для ограничения запросов с реализациями in-memory (для dev) и Redis (для prod).
- **Изоляция:** Весь серверный код, включая экшены и сервисы, должен находиться в файлах с суффиксом `*.server.ts`, чтобы обеспечить строгое разделение логики.

---

## 6. UX и Детали Потока Входа

- **Возможность изменить номер:** На экране ввода кода должна быть ссылка/кнопка для возврата на предыдущий шаг.
- **Локализация:** Все тексты ошибок, подсказок и кнопок должны быть локализованы (минимум RU/EN).
- **Состояния UI:** Предусмотреть состояния загрузки (`loading`), ошибок, таймер обратного отсчета для повторной отправки кода.
- **Маскирование номера:** На экране верификации номер телефона должен быть частично скрыт (например, `+7 (999) ***-**-12`).
- **Поддержка:** Ссылка "Нужна помощь?" для быстрой связи с поддержкой.

---

## 7. Логирование и Наблюдаемость

- **Структурные логи:** Все ключевые события аутентификации должны логироваться с четкой структурой: `login_code_requested`, `login_code_verified`, `login_code_failed`, `session_created`, `rate_limit_triggered`.
- **Бизнес-метрики:** На основе логов отслеживать конверсию воронки `request → verify → session`.
- **Корреляция:** Использовать `traceId` для связывания всех логов в рамках одной операции.

---

## 8. Документация и ADR

- **ADR:** Создать документ, объясняющий решение использовать аутентификацию по телефону без пароля на первом этапе и описывающий план перехода к полноценному RBAC/2FA.
- **Диаграммы:** Создать секвенс-диаграмму потока `Login → Verify → Session`.
- **Ключи локализации:** Составить таблицу ключей для текстов (например, `auth.invalid_code`, `auth.code_expired`).

---

## 9. Тестирование

- **Unit-тесты:** Для `PhoneNormalizer`, сервисов генерации и проверки кодов, управления сессиями.
- **Интеграционные тесты:** Для серверных экшенов с моками внешних зависимостей (SMS-провайдер) и проверкой работы rate-limiter.
- **E2E-тесты (Playwright):** Сценарии "happy path", ввод неверного/просроченного кода, проверка кулдауна, редиректы на `/login` и обратно.

---

## 10. CI/CD и Гигиена Конфигурации

- **`.env.example`:** Создать и поддерживать файл с примерами всех необходимых переменных окружения.
- **Quality Gates:** Настроить CI для автоматического запуска линтера, тайпчекера и тестов при каждом push.
- **Зависимости:** Строго следовать правилу разделения `dependencies` и `devDependencies`.
- **Секреты:** Никаких ключей в коде. Все секреты только через переменные окружения.

---

## 11. Юридические аспекты и Приватность

- **Согласие:** На форме входа должен быть обязательный чекбокс со ссылкой на Политику конфиденциальности и Пользовательское соглашение.
- **Хранение данных:** Определить и задокументировать политику хранения персональных данных и логов.

---

## 12. Совместимость с Будущим

- **JWT:** После успешной верификации кода предусмотреть возможность (под флагом `FEATURE_JWT_ISSUING`) выпускать короткоживущий JWT для будущих API.
- **Аудит:** Сразу заложить в `AuditEvent` поле `actor`, которое может быть как `user_id`, так и `anonymous`.

---

## 13. Контракты (TypeScript)

Контракты для домена IAM определены в `src/lib/iam/iam.contracts.ts`.

---

## 14. Definition of Done (Критерии готовности)

- [ ] Формы `login` и `verify` работают, используя заглушку SMS-провайдера и rate-limiter.
- [ ] Cookie-сессия создается с флагами `HttpOnly`, `Secure`, `SameSite=Lax`.
- [ ] Функция `logout` корректно инвалидирует сессию на сервере и удаляет cookie.
- [ ] Страница `/account` доступна только авторизованным пользователям и находится под флагом `FEATURE_ACCOUNT`.
- [ ] Реализованы корректные редиректы: `/account` → `/login` без сессии и обратно после входа.
- [ ] Весь серверный код находится в `*.server.ts`.
- [ ] Ключевые события логируются; сообщения об ошибках локализованы (RU/EN).
- [ ] Unit и интеграционные тесты покрывают основную логику и проходят в CI.
- [ ] Созданы ADR и секвенс-диаграмма.

---

## 15. План Миграции на Stage 2

- **Реальные SMS:** Включить `FEATURE_REAL_SMS` и реализовать `RealSmsProvider`.
- **JWT для API:** Включить `FEATURE_JWT_ISSUING` для поддержки Ops API.
- **RBAC:** Ввести модели `Role`, `Permission` и связать их с моделью `User`.
