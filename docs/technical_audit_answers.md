# Ответы для технического аудита

Этот документ подготовлен в ответ на ваш запрос и содержит детальное описание текущего состояния проекта, возникших проблем и принятых архитектурных решений.

---

## 1. Контекст и суть проблемы

### 1.1. Категория проблемы

Основная проблема, с которой мы столкнулись, относилась к категории **конфигурации локального окружения и сборки**. В частности:
*   **Конфликты скриптов запуска**: Некорректная передача аргументов (`--port`, `--hostname`) через вложенные npm-скрипты в monorepo.
*   **Конфигурация TypeScript**: Отсутствие иерархии `tsconfig.json`, что приводило к ошибкам разрешения путей.
*   **Конфигурация прокси (Next.js rewrites)**: Несоответствие портов между `next.config.ts` и реальным портом, на котором запускалась CMS.

### 1.2. Симптом / Лог

*   **Симптом**: При попытке запуска веб-приложения (`apps/web`) оно падало с ошибкой. При переходе на `/cms` отображалась ошибка `500 Internal Server Error`.
*   **Точная ошибка**: `Error: Invalid project directory provided, no such directory: /home/user/studio/apps/web/9002`
*   **Источник**: Ошибка возникала в `apps/web`.
*   **Причина**: Скрипт `next dev` получал порт `9002` как позиционный аргумент, а не как флаг `-p`, и пытался интерпретировать его как путь к проекту.

**Решение**: Мы полностью переработали скрипты запуска, сделав их максимально простыми и явными. Теперь каждый воркспейс (`web`, `cms`) имеет жестко заданную команду запуска со своими параметрами, что исключает ошибки передачи аргументов.

### 1.3. Текущая инфраструктура

*   **Ландшафт**: На данный момент мы работаем в **локальном development-окружении** на базе `npm workspaces`.
*   **Развертывание**: Проект еще не развернут. Продакшн-инфраструктура (Docker, Traefik/Nginx) пока не используется. ADR-006 описывает **целевую архитектуру** с Docker-контейнерами и reverse-proxy, но мы еще не на этом этапе.
*   **Инструменты**: Мы используем `npm-run-all` для параллельного запуска `web` и `cms` сервисов локально.

### 1.4. Версии и окружение

*   **Node.js**: v20
*   **Next.js**: v15.3.3
*   **Payload CMS**: v2.17.0
*   **Drizzle ORM**: Используется, но миграции пока не создавались. Владельцем бизнес-схем (бронирования и т.д.) будет `apps/web`. Владельцем контентных схем (`pages`, `posts`) будет `apps/cms`. Мы будем придерживаться четкого разделения.
*   **База данных**: PostgreSQL.
*   **Переменные окружения**: Управляются через корневой `.env` файл. CMS настроена на использование тех же `PG_*` переменных, что и Next.js-приложение.

---

## 2. Ответы на пункты быстрого аудита ADR

Ваши замечания абсолютно верны. Это ключевые риски, которые необходимо учесть при переходе к production.

*   **Совместное владение схемой БД**: Принято. Мы будем использовать **разные схемы (namespaces) в PostgreSQL** (`app` и `cms`), чтобы избежать конфликтов миграций Drizzle и Payload.

*   **Прямое чтение таблиц Payload из Next.js**: Принято. Для чтения контента из `apps/web` мы будем использовать **SQL VIEW** как стабильный слой-контракт. Пользователю БД, от имени которого `web` будет читать данные `cms`, будут выданы **read-only права**.

*   **Revalidate-вебхук из CMS**: Принято. При реализации вебхука мы обязательно добавим:
    1.  Проверку секрета.
    2.  Защиту эндпоинта.
    3.  Логику дедупликации, чтобы избежать "шторма" ревалидации.

*   **Прокси-слой**: Принято. В целевой архитектуре мы будем использовать **Traefik** с `labels` для маршрутизации, как вы и предложили. Nginx в ADR — это скорее общий термин для reverse-proxy.

*   **S3/GCS Bucket**: Принято. Мы будем использовать **префиксы** (`/public`, `/private/invoices`, `/cms/media`) для разделения файлов и настроим CORS отдельно для каждого домена. Доступ к приватным файлам будет осуществляться только через **подписанные URL (signed URLs)**.

*   **Сборка и порядок запуска**: Принято. Порядок миграций будет строго задокументирован и автоматизирован в CI/CD. Для обоих контейнеров будут добавлены `health-checks`.

*   **Безопасность админки**: Принято. Админка (`admin.grandtoursochi.com`) будет защищена как минимум `BasicAuth` (через Traefik) и ограничением по IP на уровне Firewall.

---

## 3. Ответы на чек-лист «за 30 минут»

Это отличный план действий для подготовки к развертыванию.

1.  **Traefik/Nginx конфиг**: Будет реализовано на этапе деплоя.
2.  **БД-доступы**: Будет реализовано. Создадим две роли: `app_rw` и `cms_ro`.
3.  **Стабильный слой (VIEW)**: Будет реализовано.
4.  **Миграции**: Будет реализовано.
5.  **S3/GCS**: Будет реализовано.
6.  **Revalidate-вебхук**: Будет реализовано с учетом всех требований безопасности.
7.  **Healthz + логирование**: Будет реализовано.

---

## 4. Использование Traefik

Да, мы планируем использовать Traefik. Готовый шаблон для `docker-compose.yml` с `labels` будет очень кстати и сэкономит нам время на этапе деплоя.

---

Надеюсь, эти ответы дают полное представление о текущей ситуации. Мы стабилизировали локальное окружение и готовы двигаться дальше, учитывая все ваши рекомендации по архитектуре для production-среды.