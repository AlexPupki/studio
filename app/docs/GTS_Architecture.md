# Архитектура Платформы "Grand Tour Sochi"

Этот документ — главный источник правды об архитектуре проекта. Он объединяет ключевые решения, правила и гайдлайны.

## 1. Философия и Принципы

- **Модульный Монолит**: Мы строим единое приложение, но с четким разделением на доменные модули (Каталог, Бронирования, Пользователи) для простоты разработки и поддержки.
- **Контракты в первую очередь (Contract-First)**: Взаимодействие между слоями (UI, BFF, сервисы) строго типизировано через общие TypeScript-интерфейсы.
- **Гексагональная Архитектура (Порты и Адаптеры)**: Бизнес-логика изолирована от внешних сервисов (БД, API, файловое хранилище). Интеграции реализуются через "адаптеры".
- **Фабрики Сервисов**: Экземпляры сервисов (AI, DB, Storage) создаются централизованно через асинхронные фабрики (`create...Service`), которые инкапсулируют всю логику конфигурации. Это защищает от ошибок инициализации.

## 2. Стек Технологий

- **Frontend и BFF**: Next.js (App Router)
- **Язык**: TypeScript
- **UI**: React, ShadCN, Tailwind CSS
- **AI**: Genkit (Google AI)
- **Хостинг**: Firebase App Hosting / Google Cloud Run
- **База Данных**: **PostgreSQL** (основная), **Redis** (кэш, очереди, rate limits). (См. [ADR-001](./01_architecture/ADR-001-database-selection.md))
- **Хранилище Файлов**: **Google Cloud Storage (GCS)**. (См. [ADR-002](./01_architecture/ADR-002-storage-selection.md))
- **CI/CD**: GitHub Actions или Cloud Build

## 3. Управление Файлами (Google Cloud Storage)

Мы используем GCS для хранения всех медиафайлов. Доступ осуществляется через временные подписанные URL (Signed URL v4), которые генерирует наш бэкенд.

- **Бакет**: `gts-mvp-media-euw4` (europe-west4)
- **Доступ**: Приватный по умолчанию. Публичный доступ запрещен на уровне бакета.
- **Процесс Загрузки**:
  1. Клиент запрашивает у нашего API ссылку на загрузку, передавая тип контента.
  2. API генерирует `Signed URL (write)` и возвращает клиенту.
  3. Клиент загружает файл напрямую в GCS по этой ссылке методом `PUT`.
- **Процесс Скачивания**:
  1. Клиент запраширует у нашего API ссылку на скачивание по ключу файла.
  2. API проверяет права и генерирует `Signed URL (read)`.
  3. Клиент скачивает/отображает файл напрямую из GCS.

## 4. Интеграция с CRM

На текущем этапе рассматриваются два основных варианта интеграции, выбор зависит от финальных бизнес-требований. (См. [ADR-003](./01_architecture/ADR-003-crm-strategy.md))

### Вариант А: YCLIENTS
- **Стиль API**: REST
- **Аутентификация**: Bearer-токен (`user_token`).
- **Ключевые сущности**: `Branch`, `Service`, `Staff`, `Record`, `Client`.
- **Основные сценарии**:
  - Получение списка услуг и доступных слотов времени.
  - Создание/изменение/отмена записей (бронирований).
  - Создание/поиск клиентов.

### Вариант Б: AmoCRM
- **Стиль API**: REST
- **Аутентификация**: OAuth 2.0
- **Ключевые сущности**: `Lead`, `Deal`, `Contact`, `Task`.
- **Основные сценарии**:
    - Двусторонняя синхронизация лидов и сделок.
    - Создание задач для операторов.
    - Интеграция с мессенджерами.


## 5. Правила Кода и Изоляция Слоёв

- **Изоляция Серверного Кода**: Любой код, использующий Node.js-специфичные модули (`fs`, `crypto`) или тяжелые SDK (`firebase-admin`, `@google-cloud/storage`), должен находиться в файлах с суффиксом `.server.ts`.
- **Запрет Прямого Импорта**: Клиентские компоненты (`/src/app/**`) не могут импортировать файлы `.server.ts`. Все взаимодействие с бэкендом происходит через Server Actions.
- **Разделение Зависимостей**: `dependencies` — только для кода, который исполняется в production. `devDependencies` — для сборки, линтинга и тестирования.

## 6. Документация

- **TSDoc/JSDoc**: Все экспортируемые функции, типы и классы должны иметь TSDoc-комментарии, описывающие их назначение, параметры (`@param`) и возвращаемое значение (`@returns`).
- **Markdown (`/docs`)**: Высокоуровневые архитектурные решения, гайды и ADR.
- **ADR (Architecture Decision Records)**: Важные архитектурные решения фиксируются в формате ADR в `/docs/01_architecture`.
- **Feature Flags**: Единый реестр фиче-флагов ведется в [ADR-004](./01_architecture/ADR-004-feature-flags-registry.md).
