# Stage 1: Фундамент — Production-Ready Аутентификация

**Цель:** Создать **минимально жизнеспособное, но production-ready ядро** системы аутентификации и управления доступом (IAM) для роли "Клиент". Этот этап — фундамент для всех будущих ролей и защищенных разделов.

---

## 1. Feature Flags и Конфигурация

Все флаги управляются через переменные окружения. Единый реестр ведется в [ADR-004](./01_architecture/ADR-004-feature-flags-registry.md).

- **`FEATURE_ACCOUNT`** (ON): Управляет доступом к личному кабинету клиента `/account`.
- **`FEATURE_I18N`** (ON): Включает локализацию (RU/EN) для UI-элементов, форм и сообщений об ошибках.
- **`FEATURE_REAL_SMS`** (OFF): Переключает между провайдером-заглушкой (вывод в консоль) и реальным SMS-шлюзом.
- **`FEATURE_CAPTCHA`** (OFF): Включает CAPTCHA после нескольких неудачных попыток входа.
- **`FEATURE_JWT_ISSUING`** (OFF): Включает генерацию JWT-токенов после успешной аутентификации для будущих API.
- **`FEATURE_PAYMENTS_ONLINE`** (OFF): Управляет видимостью заглушек для онлайн-оплат.
- **`FEATURE_SEAT_SHARING`** (OFF): Управляет функционалом совместных поездок (seat-sharing).
- **`FEATURE_PARTNER_PORTAL`** (OFF): Управляет доступом к партнерскому порталу.

---

## 2. Модель Данных IAM (MVP)

Контракты определены в `src/lib/database/db.contracts.ts`.

- **`User`**: `id`, `phoneE164`, `createdAt`, `lastLoginAt`, `status` ('active'|'blocked'), `preferredLanguage`.
- **`LoginCode`**: `id`, `phoneE164`, `codeHash`, `issuedAt`, `expiresAt`, `attempts`, `usedAt`, `createdIp`, `createdUa`.
- **`Session`**: `id`, `userId`, `issuedAt`, `expiresAt`, `ip`, `ua`, `revokedAt`.
- **`AuditEvent`**: `id`, `ts`, `userId`, `event`, `ip`, `ua`, `meta`.

**Политики OTP:**
- **Генерация:** 6 цифр.
- **Срок жизни (TTL):** 5 минут.
- **Хранение:** В БД хранится **только хэш кода** (`codeHash`), вычисленный с "перцем" (`PEPPER`).

---

## 3. Защита от Брутфорса и Злоупотреблений

- **Нормализация телефона:** Все номера телефонов приводятся к формату E.164 перед использованием.
- **Rate Limiting:**
  - **Запрос кода (`requestLoginCode`):** Реализован базовый rate-limiter (заглушка).
  - **Проверка кода (`verifyLoginCode`):** 5 неудачных попыток для одного выданного кода, после чего код становится недействительным.
- **Кулдаун:** Кнопка "Отправить код повторно" неактивна 60 секунд.

---

## 4. Сессии и Безопасность

- **Cookies:** Сессионные куки должны быть установлены с флагами:
  - `HttpOnly`: Защита от доступа через JavaScript.
  - `Secure`: Передача только по HTTPS (в production).
  - `SameSite=Lax`: Защита от CSRF-атак.
  - `Path=/`: Кука доступна на всем сайте.
  - **TTL:** 30 дней (настраивается через `SESSION_TTL_DAYS`).
- **Шифрование:** Сессия шифруется с использованием `aes-256-gcm` и секрета `SESSION_SECRET_KEY`.
- **Logout:** Выход из системы инвалидирует сессию на сервере (в БД) и удаляет cookie у клиента.
- **CSRF:** Все мутирующие операции (формы) выполняются через Server Actions (POST), которые имеют встроенную защиту от CSRF в Next.js.

---

## 5. Архитектура: Адаптеры и Изоляция

- **`SmsProvider`:** Создан интерфейс `ISmsProvider` и реализация `StubSmsProvider`.
- **`RateLimiter`:** Создан интерфейс `IRateLimiter` и реализация `InMemoryRateLimiter`.
- **Изоляция:** Весь серверный код, включая экшены и сервисы, использует директиву `'use server'`.

---

## 6. UX и Детали Потока Входа

- **Возможность изменить номер:** Реализована.
- **Локализация:** Тексты ошибок, подсказок и кнопок реализованы на русском языке.
- **Состояния UI:** Реализованы состояния загрузки (`loading`), ошибок, таймер обратного отсчета.
- **Маскирование номера:** Реализовано (`+7 (999) ***-**-12`).
- **Поддержка:** Добавлена ссылка "Нужна помощь?".

---

## 7. Логирование и Наблюдаемость

- **Структурные логи:** Реализован сервис аналитики, который логирует события: `login_code_requested`, `login_code_verified`, `login_code_failed`, `new_user_registered`.

---

## 8. Документация и ADR

- **ADR:** Создан документ [ADR-005](./01_architecture/ADR-005-passwordless-auth.md), объясняющий решение использовать аутентификацию по телефону.
- **Диаграммы:** (Не реализовано в рамках этой сессии).
- **Ключи локализации:** (Реализовано в коде).

---

## 9. Тестирование

- **Unit-тесты, Интеграционные тесты, E2E-тесты:** (Не реализовано в рамках этой сессии).

---

## 10. CI/CD и Гигиена Конфигурации

- **`.env.example`:** Требуется создать для отражения всех переменных.
- **Quality Gates:** Настроены по умолчанию в Next.js (lint, typecheck).
- **Зависимости:** Разделены на `dependencies` и `devDependencies`.
- **Секреты:** Все секреты используются через переменные окружения.

---

## 11. Юридические аспекты и Приватность

- **Согласие:** На форме входа реализован обязательный чекбокс со ссылками на документы.

---

## 12. Совместимость с Будущим

- **JWT:** В архитектуре предусмотрена возможность выпуска JWT (под флагом).
- **Аудит:** В архитектуре предусмотрена модель `AuditEvent`.

---

## 13. Контракты (TypeScript)

Контракты для домена IAM определены в `src/lib/database/db.contracts.ts`.

---

## 14. Definition of Done (Критерии готовности)

- [x] Формы `login` и `verify` работают, используя заглушку SMS-провайдера и rate-limiter.
- [x] Cookie-сессия создается с флагами `HttpOnly`, `Secure`, `SameSite=Lax`.
- [x] Функция `logout` корректно инвалидирует сессию на сервере и удаляет cookie.
- [x] Страница `/account` доступна только авторизованным пользователям и находится под флагом `FEATURE_ACCOUNT`.
- [x] Реализованы корректные редиректы: `/account` → `/login` без сессии и обратно после входа.
- [x] Весь серверный код находится в файлах с `'use server'`.
- [x] Ключевые события логируются; сообщения об ошибках локализованы (RU).
- [x] Создан ADR.
- [ ] Unit и интеграционные тесты покрывают основную логику и проходят в CI.
- [ ] Создана секвенс-диаграмма.

---

## 15. План Миграции на Stage 2

- **Реальные SMS:** Включить `FEATURE_REAL_SMS` и реализовать `RealSmsProvider`.
- **JWT для API:** Включить `FEATURE_JWT_ISSUING` для поддержки Ops API.
- **RBAC:** Ввести модели `Role`, `Permission` и связать их с моделью `User`.